name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ── Gate 1: Lint & Type-check ──
  lint:
    name: Lint & Type-check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: app/package-lock.json

      - run: npm ci

      - name: TypeScript type-check
        run: npx tsc --noEmit

      - name: Next.js lint
        run: npm run lint

  # ── Gate 2: Unit & Integration tests ──
  test:
    name: Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: app/package-lock.json

      - run: npm ci

      - name: Run vitest
        run: npm test -- --reporter=verbose

  # ── Gate 3: Next.js production build ──
  build:
    name: Build
    needs: [lint, test]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: app/package-lock.json

      - run: npm ci

      - name: Next.js build
        run: npm run build

  # ── Gate 4: Schema validation against PostgreSQL ──
  schema:
    name: Schema Validation
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: cloudintel
          POSTGRES_PASSWORD: ci-test-password
          POSTGRES_DB: cloud_identity_intel
        options: >-
          --health-cmd "pg_isready -U cloudintel -d cloud_identity_intel"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v6

      - name: Wait for PostgreSQL
        run: |
          for i in $(seq 1 15); do
            pg_isready -h localhost -U cloudintel -d cloud_identity_intel && break
            sleep 2
          done

      - name: Apply schema (sorted order)
        env:
          PGPASSWORD: ci-test-password
        run: |
          for sqlfile in $(find schema -name '*.sql' | sort); do
            echo "▸ Applying $sqlfile"
            psql -h localhost -U cloudintel -d cloud_identity_intel \
              --set ON_ERROR_STOP=1 -f "$sqlfile"
          done

      - name: Verify tables exist
        env:
          PGPASSWORD: ci-test-password
        run: |
          psql -h localhost -U cloudintel -d cloud_identity_intel -c "
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'public' AND table_type = 'BASE TABLE'
            ORDER BY table_name;" | tee /tmp/tables.txt

          for tbl in canonical_users canonical_emails canonical_user_provider_links \
                     google_workspace_users google_workspace_groups google_workspace_memberships \
                     aws_identity_center_users aws_identity_center_groups aws_identity_center_memberships \
                     aws_accounts aws_account_assignments \
                     gcp_organisations gcp_projects gcp_project_iam_bindings \
                     github_organisations github_users github_teams \
                     github_team_memberships github_org_memberships \
                     github_repositories github_repo_team_permissions github_repo_collaborator_permissions \
                     resource_access_grants identity_reconciliation_queue \
                     ingestion_runs audit_log; do
            grep -q "$tbl" /tmp/tables.txt || { echo "MISSING: $tbl"; exit 1; }
          done
          echo "All expected tables present."

      - name: Verify seed data counts
        env:
          PGPASSWORD: ci-test-password
        run: |
          psql -h localhost -U cloudintel -d cloud_identity_intel -c "
            SELECT 'canonical_users' AS entity, COUNT(*) FROM canonical_users
            UNION ALL SELECT 'canonical_user_provider_links', COUNT(*) FROM canonical_user_provider_links
            UNION ALL SELECT 'github_users', COUNT(*) FROM github_users
            UNION ALL SELECT 'github_teams', COUNT(*) FROM github_teams
            ORDER BY entity;"

      - name: Verify tenant_id column on key tables
        env:
          PGPASSWORD: ci-test-password
        run: |
          echo "Checking tenant_id column exists on all data tables..."
          MISSING=0
          for tbl in canonical_users google_workspace_users aws_identity_center_users \
                     github_organisations github_users github_teams \
                     aws_accounts gcp_projects; do
            psql -h localhost -U cloudintel -d cloud_identity_intel -tAc "
              SELECT COUNT(*) FROM information_schema.columns
              WHERE table_schema = 'public' AND table_name = '$tbl' AND column_name = 'tenant_id';" \
            | grep -q '^1$' || { echo "MISSING tenant_id on: $tbl"; MISSING=1; }
          done
          if [ $MISSING -eq 1 ]; then exit 1; fi
          echo "All key tables have tenant_id column."
