name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ── Gate 1: Lint & Type-check ──
  lint:
    name: Lint & Type-check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: app/package-lock.json

      - run: npm ci

      - name: TypeScript type-check
        run: npx tsc --noEmit

      - name: Next.js lint
        run: npm run lint

  # ── Gate 2: Unit & Integration tests ──
  test:
    name: Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: app/package-lock.json

      - run: npm ci

      - name: Run vitest
        run: npm test -- --reporter=verbose

  # ── Gate 3: Next.js production build ──
  build:
    name: Build
    needs: [lint, test]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: app/package-lock.json

      - run: npm ci

      - name: Next.js build
        run: npm run build

  # ── Gate 4: Schema validation against PostgreSQL ──
  schema:
    name: Schema Validation
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: cloudintel
          POSTGRES_PASSWORD: ci-test-password
          POSTGRES_DB: cloud_identity_intel
        options: >-
          --health-cmd "pg_isready -U cloudintel -d cloud_identity_intel"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v4

      - name: Wait for PostgreSQL
        run: |
          for i in $(seq 1 15); do
            pg_isready -h localhost -U cloudintel -d cloud_identity_intel && break
            sleep 2
          done

      - name: Apply schema (sorted order)
        env:
          PGPASSWORD: ci-test-password
        run: |
          for sqlfile in $(find schema -name '*.sql' | sort); do
            echo "▸ Applying $sqlfile"
            psql -h localhost -U cloudintel -d cloud_identity_intel \
              --set ON_ERROR_STOP=1 -f "$sqlfile"
          done

      - name: Verify tables exist
        env:
          PGPASSWORD: ci-test-password
        run: |
          psql -h localhost -U cloudintel -d cloud_identity_intel -c "
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'public' AND table_type = 'BASE TABLE'
            ORDER BY table_name;" | tee /tmp/tables.txt

          for tbl in tenant person person_link cloud_provider \
                     aws_account aws_iam_user aws_idc_user aws_idc_group \
                     gcp_project gcp_workspace_user gcp_workspace_group \
                     github_organisation github_user github_team \
                     github_team_membership github_org_membership; do
            grep -q "$tbl" /tmp/tables.txt || { echo "MISSING: $tbl"; exit 1; }
          done
          echo "All expected tables present."

      - name: Verify seed data counts
        env:
          PGPASSWORD: ci-test-password
        run: |
          psql -h localhost -U cloudintel -d cloud_identity_intel -c "
            SELECT 'person' AS entity, COUNT(*) FROM person
            UNION ALL SELECT 'person_link', COUNT(*) FROM person_link
            UNION ALL SELECT 'github_user', COUNT(*) FROM github_user
            UNION ALL SELECT 'github_team', COUNT(*) FROM github_team
            ORDER BY entity;"

      - name: Verify RLS enabled
        env:
          PGPASSWORD: ci-test-password
        run: |
          psql -h localhost -U cloudintel -d cloud_identity_intel -c "
            SELECT relname, relrowsecurity, relforcerowsecurity
            FROM pg_class
            WHERE relname IN (
              'person','aws_account','gcp_project',
              'github_organisation','github_user','github_team'
            ) AND relkind = 'r'
            ORDER BY relname;" | tee /tmp/rls.txt

          # All should show t | t
          if grep -c "| f" /tmp/rls.txt > /dev/null 2>&1; then
            echo "RLS not enabled on all tables!"
            exit 1
          fi
          echo "RLS verified on all tables."

      - name: Verify redaction views
        env:
          PGPASSWORD: ci-test-password
        run: |
          psql -h localhost -U cloudintel -d cloud_identity_intel -c "
            SELECT viewname FROM pg_views
            WHERE viewname LIKE 'v_%_redacted'
            ORDER BY viewname;"
