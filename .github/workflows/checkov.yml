name: Checkov IaC Security

on:
  push:
    branches: [main]
    paths:
      - "infra/**"
      - "schema/**"
      - ".github/workflows/checkov.yml"
  pull_request:
    branches: [main]
    paths:
      - "infra/**"
      - "schema/**"

permissions:
  contents: read
  security-events: write

jobs:
  checkov-terraform:
    name: Checkov — Terraform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov on Terraform
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infra
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,results.sarif
          soft_fail: true
          skip_check: CKV_DOCKER_2,CKV_DOCKER_3,CKV_SECRET_6,CKV_AWS_130,CKV_AWS_382,CKV_AWS_354,CKV_AWS_327,CKV_AWS_162
          # CKV_DOCKER_2: healthcheck — we have one
          # CKV_DOCKER_3: user instruction — dev container
          # CKV_SECRET_6: false positive on password_encryption=scram-sha-256
          # CKV_AWS_130: public subnets intentionally assign public IPs
          # CKV_AWS_382: Aurora SG egress needed for outbound connectivity
          # CKV_AWS_354: KMS CMK for Performance Insights — unnecessary cost for dev
          # CKV_AWS_327: KMS CMK for RDS encryption — unnecessary cost for dev
          # CKV_AWS_162: IAM auth for RDS — not required for this architecture

      - name: Upload Terraform SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
          category: checkov-terraform
        continue-on-error: true

  checkov-secrets:
    name: Checkov — Secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov secrets scanner
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: secrets
          output_format: cli,sarif
          output_file_path: console,results.sarif
          soft_fail: true
          skip_check: CKV_SECRET_6
          # CKV_SECRET_6: false positive on postgres config strings

      - name: Upload Secrets SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
          category: checkov-secrets
        continue-on-error: true

  checkov-github-actions:
    name: Checkov — GitHub Actions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov on GitHub Actions
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .github
          framework: github_actions
          output_format: cli,sarif
          output_file_path: console,results.sarif
          soft_fail: true

      - name: Upload GHA SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
          category: checkov-github-actions
        continue-on-error: true
